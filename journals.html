<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daftar Jurnal - PubGlow</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --primary: #667eea;
      --secondary: #764ba2;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
    }
    
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      padding: 60px 0 40px;
      margin-bottom: 30px;
    }
    
    .header h1 {
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    .filters-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .filters-card h5 {
      color: var(--primary);
      font-weight: 700;
      margin-bottom: 20px;
    }
    
    .scope-filter-group {
      max-height: 150px;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 10px;
      background: #f9f9fa;
    }
    
    .month-filter-group {
      max-height: 120px;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 10px;
      background: #f9f9fa;
    }
    
    .month-filter-group .form-check {
      display: inline-block;
      width: 32%;
      margin-right: 1%;
      font-size: 0.9rem;
    }
    
    .journal-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: all 0.3s;
      border-left: 4px solid var(--primary);
    }
    
    .journal-card:hover {
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      transform: translateY(-3px);
    }
    
    .journal-card h5 {
      color: var(--primary);
      font-weight: 700;
      margin-bottom: 12px;
    }
    
    .journal-info {
      font-size: 0.95rem;
      color: #555;
      line-height: 1.8;
    }
    
    .badge-custom {
      padding: 5px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.85rem;
    }
    
    .loading-spinner {
      text-align: center;
      padding: 50px;
    }
    
    .btn-filter {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 30px;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .btn-filter:hover {
      background: var(--secondary);
      color: white;
      transform: translateY(-2px);
    }
    
    .btn-reset {
      background: #6c757d;
      color: white;
      border: none;
      padding: 10px 30px;
      border-radius: 8px;
      font-weight: 600;
    }
    
    .result-info {
      background: white;
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1>üìö Daftar Jurnal</h1>
          <p class="mb-0">Temukan jurnal yang sesuai dengan kebutuhan publikasi Anda</p>
        </div>
        <a href="index.html" class="btn btn-light">‚Üê Beranda</a>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="row">
      <!-- Filters Sidebar -->
      <div class="col-lg-3">
        <div class="filters-card">
          <h5>üîç Filter & Urutan</h5>
          
          <!-- Search -->
          <div class="mb-3">
            <label class="form-label fw-bold">Cari Jurnal</label>
            <input type="text" class="form-control" id="searchInput" 
              placeholder="Nama jurnal atau instansi...">
          </div>

          <!-- Akreditasi -->
          <div class="mb-3">
            <label class="form-label fw-bold">Akreditasi</label>
            <select class="form-select" id="filterAkreditasi">
              <option value="">Semua Akreditasi</option>
              <option value="SINTA 1">SINTA 1</option>
              <option value="SINTA 2">SINTA 2</option>
              <option value="SINTA 3">SINTA 3</option>
              <option value="SINTA 4">SINTA 4</option>
              <option value="SINTA 5">SINTA 5</option>
              <option value="SINTA 6">SINTA 6</option>
              <option value="Non-SINTA">Non-SINTA</option>
              <option value="Scopus Q1">Scopus Q1</option>
              <option value="Scopus Q2">Scopus Q2</option>
              <option value="Scopus Q3">Scopus Q3</option>
              <option value="Scopus Q4">Scopus Q4</option>
            </select>
          </div>

          <!-- Scope (Multiple) -->
          <div class="mb-3">
            <label class="form-label fw-bold">Scope (bisa pilih banyak)</label>
            <div id="scopeFilterContainer" class="scope-filter-group">
              <div class="text-center text-muted">
                <span class="spinner-border spinner-border-sm"></span> Loading...
              </div>
            </div>
          </div>

          <!-- Harga Range -->
          <div class="mb-3">
            <label class="form-label fw-bold">Harga Publikasi (Rp)</label>
            <div class="row g-2">
              <div class="col-6">
                <input type="number" class="form-control" id="priceMin" 
                  placeholder="Min" min="0" step="100000">
              </div>
              <div class="col-6">
                <input type="number" class="form-control" id="priceMax" 
                  placeholder="Max" min="0" step="100000">
              </div>
            </div>
          </div>

          <!-- Bulan Terbit -->
          <div class="mb-3">
            <label class="form-label fw-bold">Bulan Terbit</label>
            <div id="monthFilterContainer" class="month-filter-group">
              <div class="form-check">
                <input class="form-check-input month-filter" type="checkbox" value="Januari" id="f_jan">
                <label class="form-check-label" for="f_jan">Jan</label>
              </div>
              <div class="form-check">
                <input class="form-check-input month-filter" type="checkbox" value="Februari" id="f_feb">
                <label class="form-check-label" for="f_feb">Feb</label>
              </div>
              <div class="form-check">
                <input class="form-check-input month-filter" type="checkbox" value="Maret" id="f_mar">
                <label class="form-check-label" for="f_mar">Mar</label>
              </div>
              <div class="form-check">
                <input class="form-check-input month-filter" type="checkbox" value="April" id="f_apr">
                <label class="form-check-label" for="f_apr">Apr</label>
              </div>
              <div class="form-check">
                <input class="form-check-input month-filter" type="checkbox" value="Mei" id="f_may">
                <label class="form-check-label" for="f_may">Mei</label>
              </div>
              <div class="form-check">
                <input class="form-check-input month-filter" type="checkbox" value="Juni" id="f_jun">
                <label class="form-check-label" for="f_jun">Jun</label>
              </div>
              <div class="form-check">
                <input class="form-check-input month-filter" type="checkbox" value="Juli" id="f_jul">
                <label class="form-check-label" for="f_jul">Jul</label>
              </div>
              <div class="form-check">
                <input class="form-check-input month-filter" type="checkbox" value="Agustus" id="f_aug">
                <label class="form-check-label" for="f_aug">Agu</label>
              </div>
              <div class="form-check">
                <input class="form-check-input month-filter" type="checkbox" value="September" id="f_sep">
                <label class="form-check-label" for="f_sep">Sep</label>
              </div>
              <div class="form-check">
                <input class="form-check-input month-filter" type="checkbox" value="Oktober" id="f_oct">
                <label class="form-check-label" for="f_oct">Okt</label>
              </div>
              <div class="form-check">
                <input class="form-check-input month-filter" type="checkbox" value="November" id="f_nov">
                <label class="form-check-label" for="f_nov">Nov</label>
              </div>
              <div class="form-check">
                <input class="form-check-input month-filter" type="checkbox" value="Desember" id="f_dec">
                <label class="form-check-label" for="f_dec">Des</label>
              </div>
            </div>
          </div>

          <!-- Fast Track -->
          <div class="mb-3">
            <label class="form-label fw-bold">Fast Track</label>
            <select class="form-select" id="filterFastTrack">
              <option value="">Semua</option>
              <option value="ya">Ada Fast Track</option>
              <option value="tidak">Tidak Ada</option>
            </select>
          </div>

          <!-- Sort By -->
          <div class="mb-3">
            <label class="form-label fw-bold">Urutkan Berdasarkan</label>
            <select class="form-select" id="sortBy">
              <option value="">Default</option>
              <option value="harga-asc">Harga: Termurah</option>
              <option value="harga-desc">Harga: Termahal</option>
              <option value="review-asc">Review: Tercepat</option>
              <option value="review-desc">Review: Terlama</option>
            </select>
          </div>

          <div class="d-grid gap-2">
            <button class="btn btn-filter" id="btnApplyFilter">
              üîç Terapkan Filter
            </button>
            <button class="btn btn-reset" id="btnResetFilter">
              üîÑ Reset
            </button>
          </div>
        </div>
      </div>

      <!-- Journals List -->
      <div class="col-lg-9">
        <!-- Result Info -->
        <div class="result-info">
          <div class="d-flex justify-content-between align-items-center">
            <span><strong id="resultCount">0</strong> jurnal ditemukan</span>
            <a href="submit-journal.html" class="btn btn-sm btn-outline-primary">
              ‚ûï Kontribusi Jurnal
            </a>
          </div>
        </div>

        <!-- Journals Container -->
        <div id="journalsList">
          <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">Memuat data jurnal...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from './js/firebase.js';
    import { collection, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    let allJournals = [];

    // Load scopes for filter
    async function loadScopesFilter() {
      try {
        const snapshot = await getDocs(collection(db, 'scopes'));
        
        if (snapshot.empty) {
          document.getElementById('scopeFilterContainer').innerHTML = 
            '<p class="text-muted mb-0 small">Tidak ada scope</p>';
          return;
        }

        let html = '';
        snapshot.forEach(doc => {
          const scope = doc.data().nama;
          html += `
            <div class="form-check">
              <input class="form-check-input scope-filter" type="checkbox" value="${scope}" id="sf_${doc.id}">
              <label class="form-check-label" for="sf_${doc.id}">
                ${scope}
              </label>
            </div>
          `;
        });
        document.getElementById('scopeFilterContainer').innerHTML = html;
      } catch (error) {
        console.error('Error loading scopes:', error);
      }
    }

    // Load journals
    async function loadJournals() {
      try {
        const q = query(collection(db, 'journals'), where('status', '==', 'aktif'));
        const snapshot = await getDocs(q);
        
        if (snapshot.empty) {
          document.getElementById('journalsList').innerHTML = `
            <div class="alert alert-info">
              <h5>Belum ada jurnal</h5>
              <p class="mb-0">Belum ada jurnal yang dipublikasikan. Silakan cek kembali nanti!</p>
            </div>
          `;
          document.getElementById('resultCount').textContent = '0';
          return;
        }

        allJournals = [];
        snapshot.forEach(doc => {
          allJournals.push({ id: doc.id, ...doc.data() });
        });

        applyFiltersAndSort();
      } catch (error) {
        console.error('Error loading journals:', error);
        document.getElementById('journalsList').innerHTML = `
          <div class="alert alert-warning">
            <p class="mb-0">Gagal memuat data jurnal. Silakan refresh halaman.</p>
          </div>
        `;
      }
    }

    function applyFiltersAndSort() {
      let filtered = [...allJournals];

      // Search filter
      const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
      if (searchTerm) {
        filtered = filtered.filter(j => 
          j.nama.toLowerCase().includes(searchTerm) || 
          j.instansi.toLowerCase().includes(searchTerm)
        );
      }

      // Akreditasi filter
      const akreditasi = document.getElementById('filterAkreditasi').value;
      if (akreditasi) {
        filtered = filtered.filter(j => j.akreditasi === akreditasi);
      }

      // Scope filter (multi-select - must match ANY selected scope)
      const selectedScopes = Array.from(document.querySelectorAll('.scope-filter:checked'))
        .map(cb => cb.value);
      if (selectedScopes.length > 0) {
        filtered = filtered.filter(j => {
          const journalScopes = Array.isArray(j.scope) ? j.scope : [j.scope];
          return selectedScopes.some(s => journalScopes.includes(s));
        });
      }

      // Price range filter
      const priceMin = parseInt(document.getElementById('priceMin').value) || 0;
      const priceMax = parseInt(document.getElementById('priceMax').value) || Infinity;
      filtered = filtered.filter(j => j.harga >= priceMin && j.harga <= priceMax);

      // Month filter (must match ANY selected month)
      const selectedMonths = Array.from(document.querySelectorAll('.month-filter:checked'))
        .map(cb => cb.value);
      if (selectedMonths.length > 0) {
        filtered = filtered.filter(j => {
          const journalMonths = Array.isArray(j.frekuensi) ? j.frekuensi : [];
          return selectedMonths.some(m => journalMonths.includes(m));
        });
      }

      // Fast track filter
      const fastTrack = document.getElementById('filterFastTrack').value;
      if (fastTrack === 'ya') {
        filtered = filtered.filter(j => j.fastTrack?.tersedia === true);
      } else if (fastTrack === 'tidak') {
        filtered = filtered.filter(j => !j.fastTrack?.tersedia);
      }

      // Sort
      const sortBy = document.getElementById('sortBy').value;
      if (sortBy === 'harga-asc') {
        filtered.sort((a, b) => a.harga - b.harga);
      } else if (sortBy === 'harga-desc') {
        filtered.sort((a, b) => b.harga - a.harga);
      } else if (sortBy === 'review-asc') {
        filtered.sort((a, b) => a.waktuReview - b.waktuReview);
      } else if (sortBy === 'review-desc') {
        filtered.sort((a, b) => b.waktuReview - a.waktuReview);
      }

      // Display results
      displayJournals(filtered);
    }

    function displayJournals(journals) {
      document.getElementById('resultCount').textContent = journals.length;

      if (journals.length === 0) {
        document.getElementById('journalsList').innerHTML = `
          <div class="alert alert-warning">
            <h5>üîç Tidak ada hasil</h5>
            <p class="mb-0">Tidak ada jurnal yang sesuai dengan filter. Coba ubah kriteria pencarian Anda.</p>
          </div>
        `;
        return;
      }

      let html = '';
      journals.forEach(journal => {
        html += renderJournalCard(journal);
      });

      document.getElementById('journalsList').innerHTML = html;
    }

    function renderJournalCard(data) {
      const scopes = Array.isArray(data.scope) ? data.scope : [data.scope];
      const scopeBadges = scopes.map(s => 
        `<span class="badge bg-info badge-custom">${s}</span>`
      ).join(' ');
      
      const months = Array.isArray(data.frekuensi) ? data.frekuensi : [];
      const monthText = months.length > 0 ? months.join(', ') : 'N/A';

      const fastTrackBadge = data.fastTrack?.tersedia ? 
        `<span class="badge bg-warning text-dark badge-custom">‚ö° Fast Track (Rp ${data.fastTrack.biaya?.toLocaleString('id-ID')})</span>` : 
        '';

      return `
        <div class="journal-card">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <h5 class="mb-0">${data.nama}</h5>
            <span class="badge bg-success badge-custom">${data.akreditasi}</span>
          </div>

          <div class="journal-info">
            <p class="mb-2">
              <strong>üèõÔ∏è Instansi:</strong> ${data.instansi}
            </p>
            <p class="mb-2">
              <strong>üìñ Scope:</strong> ${scopeBadges}
            </p>
            <p class="mb-2">
              <strong>üí∞ Biaya Publikasi:</strong> Rp ${data.harga?.toLocaleString('id-ID')}
            </p>
            <p class="mb-2">
              <strong>‚è±Ô∏è Waktu Review:</strong> ${data.waktuReview} bulan
            </p>
            <p class="mb-2">
              <strong>üìÖ Bulan Terbit:</strong> ${monthText}
            </p>
            ${fastTrackBadge ? `<p class="mb-2">${fastTrackBadge}</p>` : ''}
            <p class="mb-0">
              <a href="${data.tautan}" target="_blank" class="btn btn-sm btn-primary">
                üîó Kunjungi Website Jurnal ‚Üí
              </a>
            </p>
          </div>
        </div>
      `;
    }

    // Event listeners
    document.getElementById('btnApplyFilter').addEventListener('click', applyFiltersAndSort);
    
    document.getElementById('btnResetFilter').addEventListener('click', () => {
      document.getElementById('searchInput').value = '';
      document.getElementById('filterAkreditasi').value = '';
      document.getElementById('priceMin').value = '';
      document.getElementById('priceMax').value = '';
      document.getElementById('filterFastTrack').value = '';
      document.getElementById('sortBy').value = '';
      
      document.querySelectorAll('.scope-filter').forEach(cb => cb.checked = false);
      document.querySelectorAll('.month-filter').forEach(cb => cb.checked = false);
      
      applyFiltersAndSort();
    });

    // Auto-filter on input change
    document.getElementById('searchInput').addEventListener('input', applyFiltersAndSort);
    document.getElementById('filterAkreditasi').addEventListener('change', applyFiltersAndSort);
    document.getElementById('filterFastTrack').addEventListener('change', applyFiltersAndSort);
    document.getElementById('sortBy').addEventListener('change', applyFiltersAndSort);

    // Initial load
    loadScopesFilter();
    loadJournals();
  </script>
</body>
</html>